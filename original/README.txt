based on original 99 lines matlab code
